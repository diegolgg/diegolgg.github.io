<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zooming Mandelbrot with Alice Replacement</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: #e8ebf0;
      font-family: "Times New Roman", Times, serif;
      font-size: 16px;
      color: #222222;
    }
    /* The pre element fills the viewport with a 20px margin on each side */
    pre#mandelbrot {
      margin: 20px;
      width: calc(100% - 40px);
      height: calc(100% - 40px);
      white-space: pre;
      font-size: 16px;
      line-height: 1.2;
      overflow: auto;
      text-align: center;
    }
  </style>
</head>
<body>
  <pre id="mandelbrot"></pre>
  <script>
    // Compute an ASCII Mandelbrot set for the given viewport.
    function mandelbrotAscii(width, height, maxIterations, centerX, centerY, scale) {
      let output = "";
      const xmin = centerX - scale / 2;
      const xmax = centerX + scale / 2;
      const aspect = height / width;
      const yRange = scale * aspect;
      const ymin = centerY - yRange / 2;
      const ymax = centerY + yRange / 2;
      
      // Use a gradient with 10 characters (from lightest to densest)
      const chars = " .:-=+*#%@&";
      
      for (let j = 0; j < height; j++) {
         const y0 = ymin + (j / (height - 1)) * (ymax - ymin);
         for (let i = 0; i < width; i++) {
            const x0 = xmin + (i / (width - 1)) * (xmax - xmin);
            let x = 0, y = 0;
            let iteration = 0;
            while (x*x + y*y <= 4 && iteration < maxIterations) {
              const xtemp = x*x - y*y + x0;
              y = 2 * x * y + y0;
              x = xtemp;
              iteration++;
            }
            let charIndex = Math.floor((iteration / maxIterations) * (chars.length - 1));
            output += chars.charAt(charIndex);
         }
         output += "\n";
      }
      return output;
    }
    
    // Helper: Check if text (ignoring newlines) is uniform.
    function isUniform(text) {
      const filtered = text.replace(/\n/g, '');
      if (filtered.length === 0) return true;
      const first = filtered.charAt(0);
      for (let i = 1; i < filtered.length; i++) {
        if (filtered.charAt(i) !== first) return false;
      }
      return true;
    }
    
    // Parameters for fractal animation.
    const width = 120;         // Number of columns.
    const height = 40;         // Number of rows.
    let scale = 3.5;           // Initial horizontal range.
    const baseIterations = 50; // Base iteration count.
    const centerX = -0.75;     // Seahorse valley region.
    const centerY = 0.1;
    const container = document.getElementById("mandelbrot");
    
    // Static detection: if output is uniform for 5 seconds, trigger Alice replacement.
    let staticTime = 0;
    const staticThreshold = 5000; // in ms (5 seconds)
    let lastTime = performance.now();
    let aliceStarted = false;
    
    // Use requestAnimationFrame for fractal animation.
    function animate() {
      let currentTime = performance.now();
      let elapsed = currentTime - lastTime;
      if (elapsed >= 20) {  // Update every ~20ms
         // Increase iterations as scale decreases.
         const currentMax = Math.floor(baseIterations * (3.5 / scale));
         let fractalOutput = mandelbrotAscii(width, height, currentMax, centerX, centerY, scale);
         container.textContent = fractalOutput;
         
         // If the fractal output is uniform (or blank), accumulate static time.
         if (isUniform(fractalOutput)) {
           staticTime += elapsed;
         } else {
           staticTime = 0;
         }
         
         scale *= 0.95; // Zoom in (reduce scale by 5% per update)
         lastTime = currentTime;
      }
      
      if (!aliceStarted) {
         requestAnimationFrame(animate);
      }
    }
    
    requestAnimationFrame(animate);
    
    // Alice in Wonderland text excerpt (replace with more text if desired).
    const aliceText = `Alice was beginning to get very tired of sitting by her sister on the bank, 
and of having nothing to do: once or twice she had peeped into the book her sister was reading, 
but it had no pictures or conversations in it, 'and what is the use of a book,' thought Alice, 
'without pictures or conversations?' `;
    let aliceIndex = 0;
    
    // When static for 5 seconds, start replacing fractal output with Alice text.
    function startAliceReplacement() {
      let content = container.textContent;
      let charArray = content.split("");
      // Create an array of indices for replaceable characters (non-newline).
      let indices = [];
      for (let i = 0; i < charArray.length; i++) {
        if (charArray[i] !== "\n") {
          indices.push(i);
        }
      }
      let replacedCount = 0;
      const total = indices.length;
      
      // Replace one character every 20ms in reading order.
      const aliceInterval = setInterval(function() {
         if (replacedCount < total) {
           charArray[indices[replacedCount]] = aliceText.charAt(aliceIndex % aliceText.length);
           aliceIndex++;
           replacedCount++;
         } else {
           // Once finished replacing all characters, loop back to the top.
           replacedCount = 0;
         }
         container.textContent = charArray.join("");
      }, 20);
    }
    
    // Periodically check if staticTime reached threshold to trigger Alice replacement.
    setInterval(function() {
      if (staticTime >= staticThreshold && !aliceStarted) {
         aliceStarted = true;
         startAliceReplacement();
      }
    }, 100);
  </script>
</body>
</html>
